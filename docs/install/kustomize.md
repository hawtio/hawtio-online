## Kustomize Installation

[Kustomize](https://kustomize.io) provides a declarative approach to the configuration customization of the installation of Hawtio. Kustomize works either with a standalone executable or as a built-in to kubectl. The [/deploy](/deploy) directory provides a base set of resources and a series of overlays that can be customized.

A [Makefile](/deploy/Makefile) is provided to enable the main installation use-cases.

To install using the Makefile, the command syntax follows:
```
$ ENV1=value1 ENV2=value2 make install
```

The following environment variables are available:
```
CLUSTER_TYPE:            Set the cluster type to install on 
                           [ openshift | k8s ]
MODE:                    Set the mode of installation
                           [ cluster | namespace ] (namespace as default)
NAMESPACE:               Set the namespace for the resources
                           (hawtio-online as default)
HAWTCONFIG:              Set whether to use configmap as hawtconfig.json
                           [ true | false ] (true by default)
INTERNAL_SERVER_SSL:     Set whether SSL should be used for internal server communication
                           (only configurable in 'k8s' -- assumed in 'openshift')
OS_CONSOLE_URL:          Set the location URL of the openshift console
                           (only used in 'openshift' mode)
DRY_RUN:                 Print the resources to be applied instead of applying them
                           [ true | false ]
```

* The default for the namespace is 'hawtio-online'. Use the NAMESPACE environment variable to install in a different namespace;
* This assumes the default mode of hawtio-online is 'namespace' so only the current namespace will be scanned for jolokia-enabled target applications. To scan the whole cluster use the MODE environment-variable and set to 'cluster';
* 

> [!WARNING]
> It is important to ensure the correct cluster type is chosen for the install, since helm has no way to verify the type of cluster is correct. Asserting the wrong cluster type can have unexpected results due to issues such as certificate generation and signing

#### OpenShift

For an OpenShift cluster, the following install command can be used:
```
$ CLUSTER_TYPE=openshift make install
```

* The Discover page in Hawtio-Online includes links to the OpenShift console. If the logged-in user has sufficient privileges, it is possible for this link to be determined by Hawtio interrogating the cluster. However, if the privileges are insufficient then this will fail. As an alternative, the console url can be specified using the OS_CONSOLE_URL environment variable and this will be utilised instead.

Upon execution, the kustomize resources and configured and deployed to the cluster. Once successfully installed, Hawtio-Online will be available on the URL specified in the installed route resource, for example:
```
$ oc get route hawtio-online
NAME            HOST/PORT                                   PATH   SERVICES        PORT    TERMINATION          WILDCARD
hawtio-online   hawtio-online-hawtio-dev.apps-crc.testing**          hawtio-online   <all>   reencrypt/Redirect   None
```

##### Certificates and Securing Connections in OpenShift

Certificates are required for communication in the application. In OpenShift, connection from the client to Hawtio-Online is secured with SSL. The certificate for this security is generated **by OpenShift** upon successful install and is stored in the _hawtio-online-tls-serving_ secret.

A second certificate is necessary for communication between Hawtio-Online and the jolokia-enabled target applications. This certificate is generated by the install process and stored in the _hawtio-online-tls-proxying_ secret.

The installation process for these secrets is automatic and it should be unnecessary to customize these certificates, once installed.

#### Kubernetes

For a kubernetes cluster, the following command can be used:
```
$ CLUSTER_TYPE=k8s make install
```

##### Certificates and Securing Connections in Kubernetes

Given the variation of kubernetes implementations, secure communication and access to target applications can also vary. Therefore, at this time only the connection between the client and the Hawtio-Online connection has been secured with SSL encryption. So during the installation, a self-signed certificate is generated and stored in the _hawtio-online-tls-serving_ secret. This is then applied to Hawtio-Online's ingress resource as well as the internal communication between the service and server processes.

In some implementations, it may be preferred to terminate the SSL encryption at the ingress and have unsecured communication internal to the cluster. In that case, set the INTERNAL_SERVER_SSL environment variable to _false_.


