name: Test Nginx Network Limits

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
jobs:
  test-nginx:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Clean build
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20

      # Build hawtio
      - name: Install Dependencies and Build Application
        run: |
          make build

      # Build container
      - name: Build Docker Image
        run: docker build -t hawtio-nginx -f Dockerfile-nginx .

      # Start environment
      - name: Start Mock Backend
        run: node tests/mock-backend.js &

      # Prepare secrets for nginx
      - name: Prepare Mock K8s Secrets
        run: |
          mkdir -p k8s-secrets

          # 1. Create a dummy token (satisfies the 'cat' command in nginx.sh)
          echo "mock-token-content" > k8s-secrets/token

          # 2. Create a dummy CA Cert (satisfies 'proxy_ssl_trusted_certificate' in nginx.conf)
          # We generate a valid self-signed cert so Nginx doesn't reject the file format
          openssl req -x509 -newkey rsa:2048 -keyout /dev/null -out k8s-secrets/ca.crt -days 365 -nodes -subj "/CN=mock-k8s"
          chmod -R 755 k8s-secrets
          chmod 644 k8s-secrets/token
          chmod 644 k8s-secrets/ca.crt

      # Starts up nginx in docker container
      - name: Run Nginx with 5000 Burst
        # --network host allows Nginx to hit localhost:3000 (Mock)
        # We inject the NGINX_MASTER_BURST to match our test expectations
        run: |
          docker run -d \
            --name hawtio-nginx \
            --network host \
            --add-host kubernetes.default:127.0.0.1 \
            -v ${{ github.workspace }}/k8s-secrets:/var/run/secrets/kubernetes.io/serviceaccount \
            -e LISTEN_SERVER_PORT=8080 \
            -e HAWTIO_ONLINE_GATEWAY_APP_PROTOCOL=http \
            -e HAWTIO_ONLINE_GATEWAY_APP_PORT=3000 \
            -e NGINX_MASTER_BURST=5000 \
            -e NGINX_LOG_LEVEL=debug \
            -e HAWTIO_ONLINE_MODE=namespace \
            -e HAWTIO_ONLINE_NAMESPACE=hawtio-dev \
            hawtio-nginx \
            /bin/sh -x ./nginx.sh

          echo "Waiting for Nginx..."
          sleep 5

          docker ps -a

          echo "Checking if Nginx is alive..."
          if ! docker ps | grep -q hawtio-nginx; then
            echo "::error::Nginx container died! Dumping logs:"
            docker logs hawtio-nginx
            exit 1
          fi
          echo "Nginx is running."

      # Install K6
      - name: Install k6
        run: |
          curl https://github.com/grafana/k6/releases/download/v0.51.0/k6-v0.51.0-linux-amd64.tar.gz -L | tar xvz --strip-components 1
          sudo install k6 /usr/local/bin/

      # Execute burst test
      - name: Run K6 Load Test
        run: k6 run tests/nginx-burst-request-test.js

      # Stopping the nginx container
      - name: Stopping permissive (5000 burst) Nginx
        run: |
          docker stop hawtio-nginx
          docker rm hawtio-nginx

      # Starts up nginx in docker container
      - name: Run Nginx with only 10 Burst
        run: |
          docker run -d \
            --name hawtio-nginx-strict \
            --network host \
            --add-host kubernetes.default:127.0.0.1 \
            -v ${{ github.workspace }}/k8s-secrets:/var/run/secrets/kubernetes.io/serviceaccount \
            -e LISTEN_SERVER_PORT=8080 \
            -e HAWTIO_ONLINE_GATEWAY_APP_PROTOCOL=http \
            -e HAWTIO_ONLINE_GATEWAY_APP_PORT=3000 \
            -e NGINX_MASTER_BURST=10 \
            -e NGINX_LOG_LEVEL=debug \
            -e HAWTIO_ONLINE_MODE=namespace \
            -e HAWTIO_ONLINE_NAMESPACE=hawtio-dev \
            hawtio-nginx \
            /bin/sh -x ./nginx.sh

          echo "Waiting for Nginx..."
          sleep 5

          docker ps -a

          echo "Checking if Nginx is alive..."
          if ! docker ps | grep -q hawtio-nginx; then
            echo "::error::Nginx container died! Dumping logs:"
            docker logs hawtio-nginx
            exit 1
          fi
          echo "Nginx is running."

      # Execute failure burst test
      - name: Run K6 Load Test
        run: k6 run tests/nginx-failure-burst-request-test.js

      # Debugging
      - name: Dump Logs on Failure
        if: failure()
        run: docker logs hawtio-nginx
