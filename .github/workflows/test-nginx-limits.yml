name: Test Nginx Network Limits

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
jobs:
  test-nginx:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # CLEAN BUILD
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      # BUILD HAWTIO
      - name: Build Application
        run: |
          make build

      # BUILD CONTAINER
      - name: Build Docker Image
        run: docker build -t hawtio-nginx-test .

      # START ENVIRONMENT
      - name: Start Mock Backend
        run: node tests/mock-backend.js &

      - name: Run Nginx
        # --network host allows Nginx to hit localhost:3000 (Mock)
        # We inject the NGINX_MASTER_BURST to match our test expectations
        run: |
          docker run -d --rm \
            --name hawtio-nginx \
            --network host \
            -e LISTEN_SERVER_PORT=8080 \
            -e HAWTIO_ONLINE_GATEWAY_APP_PROTOCOL=http \
            -e HAWTIO_ONLINE_GATEWAY_APP_PORT=3000 \
            -e NGINX_MASTER_BURST=5000 \
            -e NGINX_LOG_LEVEL=debug \
            hawtio-nginx-test
          sleep 5

      # 4. EXECUTE ATTACK
      - name: Run K6 Load Test
        uses: grafana/k6-action@v0.3.0
        with:
          filename: tests/nginx-hardening.js

      # 5. DEBUGGING
      - name: Dump Logs on Failure
        if: failure()
        run: docker logs hawtio-nginx
